@model LogisticDispatchViewModel
@{
    ViewData["Title"] = "Service Request/Approval Details";
    int i = 1;
}

<style>
    @@media print {
        body {
            font-family: Arial, sans-serif;
            color: #333;
            margin: 0;
            padding: 0;
        }
    }
</style>
<div class="container my-4">
    <div class="form-buttons">
        <a class="btn btn-warning" asp-action="Index"><i class="fa fa-angle-left"></i> Back</a>
        <button class="btn btn-success" type="button" onclick="printDiv('print')">
            <i class="fa fa-print" aria-hidden="true"></i> Print
        </button>
        <a asp-controller="Courier" asp-action="SupportingFile" class="btn btn-info">
            <i class="fa fa-file" aria-hidden="true"></i> View Files
        </a>
    </div>
    <br />
    <section id="print">
        <div class="card box-shadow">
            <div class="card-header bg-white text-black">
                <div class="row align-items-center">
                    <!-- Left: Logo -->
                    <div class="col-4">
                        <img src="~/images/logo.png"
                             class="img-fluid"
                             style="height:80px;width:200px; mix-blend-mode: multiply; opacity:0.8;"
                             alt="Logo" />
                    </div>
                    <!-- Middle: Title -->
                    <div class="col-4 text-center">
                        <h3 class="card-title mb-0">@ViewData["Title"]</h3>
                    </div>
                    <!-- Right: Date/Time -->
                    <div class="col-4 text-right">
                        <p class="mb-0 small">
                            @DateTime.Now.ToString("MMM dd, yyyy hh:mm tt")
                        </p>
                    </div>
                </div>
            </div>
            <hr />
            <div class="card-body">
                <h5 class="mb-3">Dispatched Details</h5>
                <br />
                <div class="row mb-3">
                    <div class="col-sm-4">
                        <p><strong>Branch:</strong> @Model.BranchName</p>
                    </div>
                    <div class="col-sm-4">
                        <p><strong>Dispatched Date:</strong> @Model.DispatchDate.ToString("MMMM dd, yyyy")</p>
                    </div>
                    <div class="col-sm-4">
                        <p><strong>Vendor Name:</strong> @Model.VendorName</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-2">
                        <p>
                            <strong>Status:</strong>
                            @if (User.IsInRole("User"))
                            {
                                <select asp-for="Status" id="Status" class="form-control" onchange="updateStatus(this.value, @Model.Id)" required>
                                    <option value="">--Select--</option>
                                    <option value="RECEIVED">RECEIVED</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger"></span>
                            }
                            else
                            {
                                <span>@Model.Status</span>
                            }
                        </p>
                    </div>
                </div>
                <hr />
                <div class="mb-4">
                    <h5 class="mb-3">Item Dispatched Details</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="thead-light">
                                <tr>
                                    <th>S.N</th>
                                    <th style="width: 35%;">Category Name</th>
                                    <th style="width: 35%;">Item Name</th>
                                    <th style="width: 10%;">Unit Type</th>
                                    <th style="width: 10%;">Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Items != null && Model.Items.Count > 0)
                                {
                                    foreach (var item in Model.Items)
                                    {
                                        <tr>
                                            <td>@i</td>
                                            <td>@item.CategoryName</td>
                                            <td>@item.ItemName</td>
                                            <td>@item.UnitType</td>
                                            <td>@item.Qty</td>
                                        </tr>
                                        i++;
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center">No Items Found</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <hr />
                <div>
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <p>
                                <strong>Remarks:</strong>
                                <span>@Model.Remarks</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

@section Scripts {
    <script>
        function printDiv(divName) {
            var printContents = document.getElementById(divName).innerHTML;
            var originalContents = document.body.innerHTML;
            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
        }

        function updateStatus(newStatus, dispatchId) {
            debugger;
            $.ajax({
                url: '@Url.Action("UpdateStatus", "Courier", new { area = "Admins" })',
                type: 'POST',
                data: { id: dispatchId, status: newStatus },
                success: function (response) {
                    if (response.success) {
                        alert("Status updated successfully.");
                    } else {
                        alert("Failed to update status.");
                    }
                },
                error: function () {
                    alert("Error occurred while updating status.");
                }
            });
        }
    </script>
}
