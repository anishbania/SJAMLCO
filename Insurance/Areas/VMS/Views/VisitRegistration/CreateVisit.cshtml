@model VisitViewModel
@{
    ViewData["Title"] = "Visitor Registration";
}

<div class="container mt-2">
    <div class="card p-4 mb-2">
        <form id="visitForm" asp-controller="VisitRegistration" asp-action="CreateVisit" method="post">
            @Html.AntiForgeryToken()

            <div id="visit-type-step">
                <h4 class="mb-3">Step 1: Select Visit Type</h4>
                <div class="form-group">
                    <label asp-for="VisitType" class="form-label"></label>
                    <select id="VisitType" class="form-control" asp-for="VisitType" asp-items="Html.GetEnumSelectList<VisitType>()">
                        <option value="">--Please select a visit type--</option>
                    </select>
                    <span asp-validation-for="VisitType" class="text-danger"></span>
                </div>
                <div class="mt-3">
                    <button id="btnContinue" type="button" class="btn btn-primary">Continue</button>
                </div>
            </div>

            <!-- QR controls (still inside the form) -->
            <div class="mt-4">
                <button id="btnShowQr" type="button" class="btn btn-outline-primary">Show QR</button>
                <button id="btnDownloadQr" type="button" class="btn btn-outline-secondary">Download QR</button>
            </div>

            <!-- QR container starts hidden; image src will be set when user clicks Show -->
            <div id="qrContainer" class="mt-3" style="display:none;">
                <h5>Open this page on your phone</h5>
                <img id="qrImage" src="" alt="QR Code for CreateVisit" style="width:200px;height:200px;" />
                <p class="small text-muted mt-2">Scan to open the Create Visit page on your phone (valid for 10 minutes).</p>
            </div>

            <div id="dynamicFields" style="margin-top:20px;"></div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            var $qrContainer = $('#qrContainer');
            var $qrImage = $('#qrImage');

            // Base endpoint for QR generation on server. Server should generate a tokenized QR (10-min).
            var qrEndpoint = '@Url.Action("QrCodeForCreateVisit", "VisitRegistration", new { area = "VMS" })';

            // Helper to force a fresh request (avoid cached PNG)
            function freshQrUrl() {
                return qrEndpoint + '?_=' + new Date().getTime();
            }

            // Show / Hide QR toggle — always request a fresh QR when showing
            $('#btnShowQr').on('click', function () {
                if ($qrContainer.is(':visible')) {
                    // hide
                    $qrContainer.hide();
                    $(this).text('Show QR');
                } else {
                    // show fresh QR (fresh token generated server-side)
                    $qrImage.attr('src', freshQrUrl());
                    $qrContainer.show();
                    $(this).text('Hide QR');
                }
            });

            // Download a fresh QR (new token)
            $('#btnDownloadQr').on('click', function () {
                var url = freshQrUrl();
                var a = document.createElement('a');
                a.href = url;
                a.download = 'createvisit-qr.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            // Continue -> hide QR controls and load step 2
            $('#btnContinue').on('click', function () {
                var visitType = $('#VisitType').val();

                if (!visitType) {
                    alert('Please select a visit type to continue.');
                    return;
                }

                // Hide QR and both buttons immediately to avoid flicker
                $qrContainer.hide();
                $('#btnShowQr').hide();
                $('#btnDownloadQr').hide();
                $('#btnShowQr').text('Show QR');

                $('#visit-type-step').hide();

                $.ajax({
                    url: '@Url.Action("GetVisitPartial", "VisitRegistration", new { area = "VMS" })',
                    type: 'GET',
                    data: { type: visitType },
                    success: function (data) {
                        $('#dynamicFields').html(data);
                        var form = $('#visitForm');
                        form.removeData('validator');
                        form.removeData('unobtrusiveValidation');
                        $.validator.unobtrusive.parse(form);
                    },
                    error: function (xhr, status, error) {
                        console.error('Failed to load dynamic fields:', error);
                        $('#visit-type-step').show();
                        $('#btnShowQr').show();
                        $('#btnDownloadQr').show();
                        alert('An error occurred. Please try again.');
                    }
                });
            });

            // Back -> show QR controls again
            $(document).on('click', '#btnBack', function () {   
                $('#dynamicFields').empty();
                $('#visit-type-step').show();
                $('#btnShowQr').show();
                $('#btnDownloadQr').show();
                $qrContainer.hide();
                $('#btnShowQr').text('Show QR');
            });
        });
    </script>
}
